<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Knotes ‚Äî Notebook (Sidebar fixed, single, collapsible)</title>

<link href="https://esp01.safelinks.protection.outlook.com/?url=https%3A%2F%2Ffonts.googleapis.com%2Fcss2%3Ffamily%3DSyncopate%3Awght%40400%3B700%26family%3DPermanent%2BMarker%26display%3Dswap&data=05%7C02%7C%7C619fc261a5954592f02308dde49c05e1%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638918080951911831%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=QbC7ZGllU4%2FiG62RV9jyiz6MwvglBJaalh8BoOqyq1Q%3D&reserved=0" rel="stylesheet">
<script src="https://esp01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fcdn.jsdelivr.net%2Fnpm%2Froughjs%404.5.2%2Fbundled%2Frough.js&data=05%7C02%7C%7C619fc261a5954592f02308dde49c05e1%7C84df9e7fe9f640afb435aaaaaaaaaaaa%7C1%7C0%7C638918080951927037%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=BxAjF%2BHZHtAYQkpPWndSqofqAfYK%2FfsfgbdG%2B6Z7aBU%3D&reserved=0"></script>

<style>
:root{
  --orange:#ee7d2d;
  --ink:#1a1a1a;
  --paper:#fffdf9;
  --muted:#7a7a7a;
  --radius:16px;
  --shadow:0 10px 26px rgba(0,0,0,.10);
  --gutter:clamp(12px,3vw,28px);
  --max:1200px;
  --sidebar:220px;
  --sidebar-collapsed:56px;
}

/* Base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:"Syncopate",-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;background:#faf6f2;color:var(--ink);-webkit-font-smoothing:antialiased;overflow-x:hidden}
button{font:inherit;cursor:pointer}
.hidden{display:none!important}
img,video{max-width:100%;display:block}
a{color:inherit;text-decoration:none}

/* Shared (Topics/Modules intact) */
.view{min-height:100vh}
.header{padding:16px var(--gutter);text-align:center}
.header h1{font-weight:700;color:var(--orange);font-size:28px;letter-spacing:.5px}
.header .sub{color:#b56f48;font-size:12px;margin-top:6px}
.fade-out{opacity:0;transform:scale(.98);transition:opacity .28s ease, transform .28s ease}

.grid{display:grid;gap:14px;padding:0 var(--gutter) 24px}
.topics{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.modules{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.card{
  display:flex;flex-direction:column;gap:8px;background:#fff;border:2px solid var(--orange);border-radius:14px;
  padding:16px;box-shadow:var(--shadow);transition:transform .15s ease,box-shadow .15s ease
}
.card {
  display: flex;
  flex-direction: column;
  gap: 8px;

  background: #fff;
  border: 2px solid var(--orange);
  border-radius: 14px;
  padding: 16px;
  box-shadow: var(--shadow);

  transition: transform .15s ease, box-shadow .15s ease;

  /* ‚úÖ auto size */
  height: auto;
  min-height: 0;

  /* ‚úÖ allow text wrapping */
  word-break: break-word;
  overflow-wrap: anywhere;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 16px 40px rgba(0,0,0,.14);
}

/* Inside text */
.card .t,
.card .m {
  line-height: 1.3;
  overflow-wrap: anywhere;
  word-break: break-word;
  hyphens: auto;
}

.card .t {
  font-weight: 700;
  font-size: clamp(16px, 1.1rem, 20px);
}

.card .m {
  color: var(--muted);
  font-size: clamp(11px, 0.9rem, 14px);
  margin-top: 4px;
}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px dashed var(--orange)}

/* Notebook header (simple) */
.nb-head{position:sticky;top:0;z-index:50;background:#fff;border-bottom:2px solid var(--orange);box-shadow:0 2px 10px rgba(0,0,0,.06)}
.nb-row{max-width:var(--max);margin:0 auto;padding:10px var(--gutter);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.back{border:1px dashed var(--orange);background:#fff;border-radius:10px;padding:8px 12px;color:var(--orange)}
.nb-title{font-weight:700;color:#2a2a2a}
.nb-meta{color:#b56f48;font-weight:700;display:flex;gap:10px;align-items:center}
.nb-shortcut{border:1px dashed #f0d6c4;border-radius:10px;padding:6px 10px;background:#fff}

/* Notebook page shell */
.page{width:100vw;margin:10px 0 0;background: radial-gradient(1200px 800px at 20% 10%, rgba(0,0,0,.015) 0, rgba(0,0,0,0) 60%), var(--paper);box-shadow:var(--shadow)}
/* Remove left padding so the sidebar sits flush-left; we‚Äôll pad the content column instead */
.page-inner{
  max-width:var(--max);margin:0 auto;padding:0 0 40px 0;
  display:grid;grid-template-columns: var(--sidebar) minmax(0,1fr);gap:16px;
}

/* Desktop sidebar (single) */
.nb-sidebar{
  grid-column:1/2; position:sticky; top:88px; height:calc(100vh - 100px);
  background:#fff;border:2px solid #f0d6c4;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,.06);
  overflow:auto;display:flex;flex-direction:column
}
.nb-side-top{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:8px 10px;border-bottom:1px dashed #f3e3d7}
.nb-side-title{font-weight:700;color:#2a2a2a;font-size:13px}
.nb-collapse{border:1px solid #f0d6c4;background:#fff;border-radius:10px;padding:6px 8px;line-height:1}
.tree{list-style:none;display:grid;gap:6px;padding:10px}
.tree .node{
  display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;cursor:pointer;border:1px solid #f3e3d7;background:#fff
}
.tree .node.active{background:#fff2e9;border-color:var(--orange)}
.node .k{font-weight:700}

/* Collapsed sidebar */
.nb-sidebar.collapsed{width:var(--sidebar-collapsed);min-width:var(--sidebar-collapsed)}
.nb-sidebar.collapsed .nb-side-title,
.nb-sidebar.collapsed .tree{display:none}
.nb-sidebar.collapsed .nb-collapse{margin:8px auto}

/* Mobile drawer ‚Äî hard hidden on desktop to avoid ‚Äúsecond sidebar‚Äù */
.drawer-toggle{display:none}
.drawer-panel{display:none}
@media (max-width: 900px){
  .page-inner{grid-template-columns: 1fr}
  .nb-sidebar{display:none}
  .drawer-toggle{display:inline-flex;border:1px dashed var(--orange);background:#fff;border-radius:10px;padding:8px 12px;color:#ee7d2d}
  .drawer-panel{position:fixed;inset:0;background:rgba(0,0,0,.15);z-index:60;display:none}
  .drawer-panel.open{display:block}
  .drawer-sheet{
    position:absolute; left:0; top:0; bottom:0; width:min(86vw, 320px);
    background:#fff; box-shadow: 10px 0 30px rgba(0,0,0,.18); padding:12px; overflow:auto; border-right:2px solid #f0d6c4;
  }
}

/* Content column (pads itself so sidebar can sit flush-left) */
.nb-content{grid-column:2/3; min-width:0; padding:0 var(--gutter)}

/* Section headers (handwritten vibe) */
.page-sec{position:relative; margin:18px 0; padding-top:14px}
.page-sec h2{
  display:inline-block;padding:8px 12px;border-radius:10px;background:#ffefdb;border:2px solid var(--orange);
  font-size:clamp(20px,4.5vw,34px); color:#1f1f1f; letter-spacing:.3px;
}
.page-sec .sub{margin:6px 0 10px;color:#6b6b6b;font-size:clamp(14px,2.8vw,18px);font-family:"Syncopate",sans-serif}

/* Handwritten inside page area */
.nb-content, .nb-content *{font-family:"Permanent Marker","Caveat","Patrick Hand",system-ui,sans-serif}

/* Flow stack & items */
.flow-root{position:relative;width:100%;max-width:900px;margin:0 auto;padding:8px 2px}
.flow-arrows{position:absolute;inset:0;pointer-events:none}
.flow-stack{display:flex;flex-direction:column;gap:18px}
.flow-item{
  position:relative;background:#fff;border:2px solid #f0d6c4;border-radius:12px;padding:14px;
  box-shadow:0 6px 14px rgba(0,0,0,.06);transform:rotate(var(--tilt,-.4deg));
  opacity:0;transition:transform .18s ease,opacity .18s ease
}
.flow-item.show{opacity:1}
.flow-item:hover{transform:rotate(0) translateY(-2px)}
.flow-item h3{font-size:22px;margin:6px 0 8px}
.flow-item p{font-size:18px;line-height:1.25;margin:0}
.flow-item.keyframe{background:#fff7ef;border-style:dashed}
.kf{display:flex;align-items:center;gap:10px;background:#fff7ef;border:2px dashed var(--orange);border-radius:10px;padding:10px}
.thumb{width:68px;height:44px;border-radius:8px;background:#ffe2cc;display:flex;align-items:center;justify-content:center}
.flow-item.code pre{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;background:#111;color:#0ee889;padding:12px;border-radius:10px;white-space:pre-wrap;margin:0}
.flow-item.quiz .opts{display:grid;gap:8px;margin-top:8px}
.flow-item.quiz .opts button{border:2px solid #f0d6c4;border-radius:10px;padding:10px;background:#fff;font-weight:700}
.flow-item.quiz .opts button.correct{border-color:#16a34a}
.flow-item.quiz .opts button.wrong{border-color:#f97316}
</style>
</head>
<body>

<!-- ===== View: Topics ===== -->
<section id="v-topics" class="view">
  <div class="header">
    <h1>Choose a Topic</h1>
    <div class="sub">We‚Äôll drop you straight into your notebook.</div>
  </div>
  <div class="grid topics" id="topicsGrid"></div>
</section>

<!-- ===== View: Modules ===== -->
<section id="v-modules" class="view hidden">
  <div class="header">
    <h1 id="topicTitle">Topic</h1>
    <div class="sub">Tap a module ‚Äî we‚Äôll open page 1.</div>
  </div>
  <div style="padding:0 var(--gutter) 10px"><button id="backTopics" class="pill">‚Üê Back to Topics</button></div>
  <div class="grid modules" id="modulesGrid"></div>
</section>

<!-- ===== View: Notebook (single sidebar, collapsible) ===== -->
<section id="v-notebook" class="view hidden">
  <div class="nb-head">
    <div class="nb-row">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="backModules" class="back">‚Üê Back</button>
        <button id="openDrawer" class="drawer-toggle">‚ò∞ Topics</button>
      </div>
      <div class="nb-title" id="modTitle">Module ‚Äî Notebook</div>
      <div class="nb-meta">
        <button id="jumpLast" class="nb-shortcut">üîñ Jump to last</button>
      </div>
    </div>
  </div>

  <div class="page">
    <div class="page-inner">
      <!-- Desktop sidebar -->
      <aside class="nb-sidebar" id="nbSidebar" aria-label="Module topics">
        <div class="nb-side-top">
          <div class="nb-side-title" id="sideTitle">Module Topics</div>
          <button class="nb-collapse" id="collapseBtn" title="Collapse sidebar" aria-label="Collapse sidebar">‚ü®</button>
        </div>
        <ul class="tree" id="treeList"></ul>
      </aside>

      <!-- Content column -->
      <main class="nb-content" id="nbContent" aria-label="Notebook content"></main>
    </div>
  </div>

  <!-- Mobile drawer (guaranteed hidden on desktop) -->
  <div class="drawer-panel" id="drawerPanel" aria-hidden="true">
    <div class="drawer-sheet">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
        <h3 id="drawerTitle" style="font-weight:700;color:#2a2a2a">Module Topics</h3>
        <button class="nb-collapse" id="closeDrawer" aria-label="Close topics">‚úï</button>
      </div>
      <ul class="tree" id="drawerTree"></ul>
    </div>
  </div>
</section>

<script>
/* ===== Demo Data ===== */
const DATA = {
  topics:[
    { id:'web', title:'Web Development', blurb:'JS, React, DB', modules:[
      { id:'react', title:'React Components', pages:[
        { label:'Topic 1 ‚Äî useEffect basics', sections:[
          { kind:'note',     title:'What is an effect?', text:'Run after paint to sync with the outside world.' },
          { kind:'keyframe', title:'Cleanup timing', t:'07:40' },
          { kind:'code',     title:'Effect sample',  code:'useEffect(()=>{\\n const id=setInterval(tick,1000);\\n return ()=>clearInterval(id);\\n},[]);' },
          { kind:'quiz',     title:'Deps Array',     q:{ prompt:'When do you add a dependency?', options:[{t:'Whenever it is referenced',correct:true},{t:'Never'},{t:'Only primitives'}], reveal:'Any referenced value should be listed (except stable refs).' } }
        ]},
        { label:'Topic 2 ‚Äî Memoization', sections:[
          { kind:'note',     title:'Memoization', text:'Fix renders with structure first.' },
          { kind:'keyframe', title:'useMemo intro', t:'02:08' }
        ]},
        { label:'Topic 3 ‚Äî useCallback', sections:[
          { kind:'note',     title:'When to use', text:'Stabilize handlers for memoized children.' },
          { kind:'quiz',     title:'Callbacks', q:{ prompt:'useCallback caches‚Ä¶', options:[{t:'Function identity',correct:true},{t:'Return value'},{t:'Both'}], reveal:'It memoizes the function identity between renders.' } }
        ]}
      ]}
    ]},
    { id:'db', title:'Databases', blurb:'SQL, Normalization', modules:[
      { id:'design', title:'Database Design', pages:[
        { label:'Topic 1 ‚Äî Normalization', sections:[
          { kind:'note',     title:'3NF', text:'Reduce redundancy; keep dependencies.' },
          { kind:'keyframe', title:'Index types', t:'05:12' },
          { kind:'code',     title:'Create Index', code:'CREATE INDEX idx_users_email ON users(email);' }
        ]}
      ]}
    ]}
  ]
};

/* ===== State ===== */
let topic=null, module_=null;

/* ===== DOM ===== */
const V_TOPICS=document.getElementById('v-topics');
const V_MODULES=document.getElementById('v-modules');
const V_NOTEBOOK=document.getElementById('v-notebook');
const topicsGrid=document.getElementById('topicsGrid');
const modulesGrid=document.getElementById('modulesGrid');
const topicTitle=document.getElementById('topicTitle');
const modTitle=document.getElementById('modTitle');

const nbSidebar=document.getElementById('nbSidebar');
const treeList=document.getElementById('treeList');
const sideTitle=document.getElementById('sideTitle');
const collapseBtn=document.getElementById('collapseBtn');

const drawerPanel=document.getElementById('drawerPanel');
const drawerTree=document.getElementById('drawerTree');
const openDrawerBtn=document.getElementById('openDrawer');
const closeDrawerBtn=document.getElementById('closeDrawer');

const nbContent=document.getElementById('nbContent');

/* ===== Topics ===== */
function renderTopics(){
  topicsGrid.innerHTML='';
  DATA.topics.forEach(t=>{
    const el=document.createElement('div');
    el.className='card';
    el.innerHTML=`<div class="t">${soften(t.title)}</div>
                  <div class="m">${soften(t.blurb||'')}</div>
                  <div class="m">Includes: videos ‚Ä¢ notes ‚Ä¢ quizzes</div>`;
    el.onclick=()=>openModules(t.id);
    topicsGrid.appendChild(el);
  });
}
function openModules(id){
  topic = DATA.topics.find(x=>x.id===id);
  topicTitle.textContent = topic.title;
  V_TOPICS.classList.add('fade-out');
  setTimeout(()=>{ V_TOPICS.classList.add('hidden'); V_MODULES.classList.remove('hidden'); V_TOPICS.classList.remove('fade-out'); renderModules(); }, 220);
}

/* ===== Modules ===== */
function renderModules(){
  modulesGrid.innerHTML='';
  topic.modules.forEach(m=>{
    const el=document.createElement('div');
    el.className='card';
    el.innerHTML=`<div class="t">${soften(m.title)}</div>
                  <div class="m">You‚Äôll see: keyframes ‚Ä¢ notes ‚Ä¢ quizzes</div>`;
    el.onclick=()=>openNotebook(m.id);
    modulesGrid.appendChild(el);
  });
}
function openNotebook(id){
  module_ = topic.modules.find(x=>x.id===id);
  V_MODULES.classList.add('fade-out');
  setTimeout(()=>{
    V_MODULES.classList.add('hidden');
    V_NOTEBOOK.classList.remove('hidden');
    V_MODULES.classList.remove('fade-out');
    modTitle.textContent = `${module_.title} ‚Äî Notebook`;
    sideTitle.textContent = module_.title;
    renderNotebook();
  }, 220);
}

function mapToKnotesPages(modulePages){
  return (modulePages||[]).map((p, idx)=>{
    const sections = Array.isArray(p.sections) ? p.sections : [];
    const notes    = sections.filter(s=>s.kind==='note');
    const keyframe = sections.find(s=>s.kind==='keyframe');
    const quiz     = sections.find(s=>s.kind==='quiz');

    const summary=[];
    for (const n of notes){
      if (n.text && summary.length<3) summary.push(n.text);
      else if (n.title && summary.length<3) summary.push(n.title);
    }
    if (!summary.length) summary.push(p.label || `Topic ${idx+1}`);

    const recap = quiz ? [{
      id:`recap-${idx}`, label:'Q1', state:'review',
      rationale: quiz.q?.reveal || 'Review this concept.'
    }] : [];

    const prompt = quiz ? {
      text:'Fancy a 1-min check?',
      retryQ:{ text:quiz.q?.prompt||'Quick check',
               options:(quiz.q?.options||[]).map((o,i)=>({ id:`opt-${i}`, text:o.t, correct:!!o.correct })) }
    } : undefined;

    return {
      id:`p-${idx}`,
      scene:{ title:p.label||`Topic ${idx+1}`, time:keyframe?.t||'' },
      summary, recap, concepts:[], prompt, xp:5 + idx*2
    };
  });
}

let __knotesApp = null;

function renderNotebook(){
  if(!module_ || !Array.isArray(module_.pages)) return;

  // 1) Build left trees as before
  treeList.innerHTML='';
  (module_.pages||[]).forEach((p,idx)=>{
    const li=document.createElement('li');
    li.innerHTML=`<div class="node" data-index="${idx}">
      <span class="k">${escapeHtml(p.label||('Topic '+(idx+1)))}</span>
    </div>`;
    treeList.appendChild(li);
  });
  document.getElementById('drawerTitle').textContent = module_.title;
  drawerTree.innerHTML='';
  (module_.pages||[]).forEach((p,idx)=>{
    const li=document.createElement('li');
    li.innerHTML=`<div class="node" data-index="${idx}">
      <span class="k">${escapeHtml(p.label||('Topic '+(idx+1)))}</span>
    </div>`;
    drawerTree.appendChild(li);
  });

  // 2) Replace old ‚Äúflow‚Äù content with the new mount
  nbContent.innerHTML = `<div id="knotes-lite-mount" style="--brand:#ee7d2d; --paper:#fffdf9; --ink:#1a1a1a; --accent:#2ea665; min-height:420px"></div>`;
  const mountEl = document.getElementById('knotes-lite-mount');
  const pages = mapToKnotesPages(module_.pages);

  // 3) Mount/update Knotes Lite
  if (!__knotesApp){
    __knotesApp = KnotesLite.mount(mountEl, {
      userId: window.CURRENT_USER_ID || 'demo-user',
      moduleId: module_.id,
      pages,
      saveReflection: async ()=>{},
      onEvent: ()=>{}
    });
    console.log('[KnotesLite] mounted', pages.length, 'pages');
  } else {
    __knotesApp.updatePages(pages);
    console.log('[KnotesLite] updated', pages.length, 'pages');
  }

  // 4) Wire sidebars to control Knotes page (instead of scroll)
  function setActive(i){
    document.querySelectorAll('.tree .node').forEach((n, idx)=> n.classList.toggle('active', idx===i));
  }
  function onIndexClick(e){
    const n=e.target.closest('.node'); if(!n) return;
    const i = +n.dataset.index;
    __knotesApp?.goTo?.(i);
    setActive(i);
    // close drawer on mobile
    if (e.currentTarget === drawerTree) closeDrawer();
  }

  treeList.addEventListener('click', onIndexClick, { once:false });
  drawerTree.addEventListener('click', onIndexClick, { once:false });

  // initial active state
  setActive(0);
}

/* Optional: keep Jump to last working with the new app */
document.getElementById('jumpLast').onclick = ()=>{
  if(!module_ || !Array.isArray(module_.pages)) return;
  const lastIndex=(module_.pages.length||1)-1;
  __knotesApp?.goTo?.(lastIndex);
  document.querySelectorAll('.tree .node').forEach((n, idx)=> n.classList.toggle('active', idx===lastIndex));
};

/* Flow items & arrows */
function renderBlock(b){
  if(b.kind==='keyframe'){
    return `<h3>${escapeHtml(b.title||'Keyframe')}</h3>
            <div class="kf"><div class="thumb">‚ñ∂</div>
              <div><div>Key moment</div><div style="font-family:Syncopate">${escapeHtml(b.t||'00:00')}</div></div>
            </div>`;
  }
  if(b.kind==='code'){
    return `<h3>${escapeHtml(b.title||'Code')}</h3><pre>${escapeHtml(b.code||'')}</pre>`;
  }
  if(b.kind==='quiz'){
    const opts=(b.q?.options||[]).map((o,i)=>`<button data-idx="${i}">${escapeHtml(o.t)}</button>`).join('');
    return `<h3>${escapeHtml(b.title||'Quiz')}</h3>
            <div class="quiz" data-id="${escapeHtml(b.title||Math.random().toString(36).slice(2))}">
              <div class="q">${escapeHtml(b.q?.prompt||'')}</div>
              <div class="opts">${opts}</div>
              <div class="reveal" style="display:none">${escapeHtml(b.q?.reveal||'')}</div>
            </div>`;
  }
  return `<h3>${escapeHtml(b.title||'Note')}</h3><p>${escapeHtml(b.text||'')}</p>`;
}

/* Arrow drawing */
function drawArrowsFor(flowRoot){
  const svg=flowRoot.querySelector('svg.flow-arrows');
  const root=flowRoot.getBoundingClientRect();
  const tiles=[...flowRoot.querySelectorAll('.flow-item')];

  svg.setAttribute('width', root.width);
  svg.setAttribute('height', root.height);
  svg.style.width = root.width+'px';
  svg.style.height= root.height+'px';
  svg.innerHTML='';

  if(tiles.length<2) return;
  const rc=rough.svg(svg);
  const stroke='#2b2b2b';

  for(let i=0;i<tiles.length-1;i++){
    const a=tiles[i].getBoundingClientRect();
    const b=tiles[i+1].getBoundingClientRect();
    const start={ x:a.left-root.left+a.width/2, y:a.bottom-root.top };
    const end  ={ x:b.left-root.left+b.width/2, y:b.top-root.top   };
    const midX=(start.x+end.x)/2;
    const ctrl={ x:midX, y:(start.y+end.y)/2-30 };
    const d=`M ${start.x} ${start.y} Q ${ctrl.x} ${ctrl.y} ${end.x} ${end.y}`;
    svg.appendChild(rc.path(d,{stroke,strokeWidth:2,roughness:1.4,bowing:1.8}));
    svg.appendChild(rc.polygon([[end.x,end.y],[end.x-8,end.y-16],[end.x+8,end.y-16]],{stroke,strokeWidth:2,fill:stroke,roughness:1.2}));
  }
}

/* Robust resize handling (mobile + fonts + drawer) */
const roMap = new WeakMap();
function observeFlowRoot(flowRoot){
  if(roMap.has(flowRoot)) return;
  const ro = new ResizeObserver(()=> drawArrowsFor(flowRoot));
  ro.observe(flowRoot);
  roMap.set(flowRoot, ro);
}
window.addEventListener('orientationchange', ()=>{
  document.querySelectorAll('.flow-root').forEach(drawArrowsFor);
});
if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(()=> {
    document.querySelectorAll('.flow-root').forEach(drawArrowsFor);
  });
}

/* Quiz interaction (simple) */
nbContent.addEventListener('click', (e)=>{
  const btn=e.target.closest('.opts button'); if(!btn) return;
  const quiz=btn.closest('.quiz');
  const options=[...quiz.querySelectorAll('.opts button')];
  const prompt=quiz.querySelector('.q')?.textContent?.trim()||'';
  const spec=findQuizInModule(prompt);
  const correctIdx = spec ? spec.options.findIndex(o=>o.correct) : 0;

  options.forEach((b,i)=>{
    b.classList.remove('correct','wrong');
    if(i===correctIdx) b.classList.add('correct');
    if(i===+btn.dataset.idx && i!==correctIdx) b.classList.add('wrong');
  });
  quiz.querySelector('.reveal').style.display='block';
});
function findQuizInModule(prompt){
  if(!module_||!Array.isArray(module_.pages)) return null;
  for(const p of module_.pages){
    for(const b of (p.sections||[])){
      if(b.kind==='quiz' && b.q?.prompt===prompt) return b.q;
    }
  }
  return null;
}

/* Helpers & nav */
function soften(str=''){ return str.replace(/([/_\-\.])/g,'$1\u200B'); }
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

document.getElementById('backTopics').onclick=()=>{
  V_MODULES.classList.add('fade-out');
  setTimeout(()=>{ V_MODULES.classList.add('hidden'); V_TOPICS.classList.remove('hidden'); V_MODULES.classList.remove('fade-out'); },220);
};
document.getElementById('backModules').onclick=()=>{
  V_NOTEBOOK.classList.add('fade-out');
  setTimeout(()=>{ V_NOTEBOOK.classList.add('hidden'); V_MODULES.classList.remove('hidden'); V_NOTEBOOK.classList.remove('fade-out'); },220);
};

/* Boot */
function renderModules(){ /* re-declared above intentionally */ modulesGrid.innerHTML=''; topic.modules.forEach(m=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="t">${soften(m.title)}</div><div class="m">You‚Äôll see: keyframes ‚Ä¢ notes ‚Ä¢ quizzes</div>`; el.onclick=()=>openNotebook(m.id); modulesGrid.appendChild(el); }); }
window.addEventListener('load', renderTopics);
</script>
</body>
</html>

<script>
(function(global){
  const CSS = `
  :host{--brand:#ee7d2d;--paper:#fffdf9;--ink:#1a1a1a;--accent:#2ea665;--line:#f0d6c4; font:500 14px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);}
  .wrap{background:var(--paper); border:2px solid var(--line); border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.10); padding:14px;}
  .grid{display:grid; grid-template-columns:3fr 2fr; gap:16px}
  .card{background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,.06)}
  .title{font-weight:900; margin-bottom:8px}
  .scene{display:flex; gap:10px; align-items:center}
  .thumb{width:140px; height:86px; border-radius:8px; background:linear-gradient(180deg,#fffdf9,#fff); border:1px dashed var(--line); display:grid; place-items:center; font-weight:800; color:#9a6a40}
  .summary div{padding:4px 0; border-bottom:1px dashed #eee}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{padding:6px 10px; border-radius:999px; background:#fff; border:1px dashed var(--brand); color:var(--brand); font-weight:700}
  .note{width:100%; min-height:120px; border:1px dashed #ddd; border-radius:10px; padding:10px; background:#fffdf4; font:500 15px/1.5 "Segoe Print","Kalam",system-ui}
  .nav{display:flex; justify-content:space-between; gap:8px; margin-top:8px}
  .btn{border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer}
  .btn.primary{background:var(--brand); color:#fff; border-color:var(--brand)}
  .pill{display:inline-block; background:#eefaf3; color:#0f7a4f; border:1px solid rgba(46,166,101,.35); border-radius:999px; padding:4px 10px; font-weight:800}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  `;
  const escapeHtml = (s)=> (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function mount(container, opts){
    const state = {
      userId: opts?.userId || 'user',
      moduleId: opts?.moduleId || '',
      pages: Array.isArray(opts?.pages) ? opts.pages : [],
      onEvent: opts?.onEvent || (()=>{}),
      saveReflection: opts?.saveReflection || (async ()=>{}),
      i: 0
    };
    container.innerHTML = '';
    const host = document.createElement('div');
    const shadow = host.attachShadow({mode:'open'});
    shadow.innerHTML = `
      <style>${CSS}</style>
      <div class="wrap">
        <div class="grid">
          <div class="card scene">
            <div class="thumb">üé¨</div>
            <div>
              <div class="title" id="sTitle"></div>
              <div id="sTime" style="color:#6b7280; font-weight:700"></div>
            </div>
          </div>

          <div class="card">
            <div class="title">Key Summary</div>
            <div class="summary" id="summary"></div>
            <div style="display:flex; gap:8px; margin-top:8px">
              <button class="btn" id="copy">Copy</button>
              <span id="copied" style="display:none;color:#0f7a4f;font-weight:800">Copied</span>
            </div>
          </div>

          <div class="card">
            <div class="title">Quiz Recap</div>
            <div id="recap" style="display:grid; gap:8px"></div>
          </div>

          <div class="card">
            <div class="title">Linked Concepts</div>
            <div class="chips" id="chips"></div>
          </div>

          <div class="card" style="grid-column:1/-1">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div class="title">Your Reflection</div>
              <span class="pill" id="xp">+0 XP</span>
            </div>
            <textarea id="note" class="note" placeholder="If I taught this, I‚Äôd say‚Ä¶"></textarea>
          </div>

          <div class="card" style="grid-column:1/-1">
            <div class="nav">
              <button class="btn" id="prev">‚Üê Prev</button>
              <div style="display:flex; gap:8px">
                <button class="btn" id="pick">Page <span id="i">1</span> of <span id="t">1</span></button>
              </div>
              <button class="btn primary" id="next">Next ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <!-- simple picker -->
      <div id="picker" style="position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); z-index:9999">
        <div style="background:#fff; border-radius:12px; width:min(720px,92vw); max-height:86vh; overflow:auto; padding:12px; box-shadow:0 20px 40px rgba(0,0,0,.2)">
          <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:10px" id="pgrid"></div>
          <div style="text-align:right; margin-top:8px"><button class="btn" id="pclose">Close</button></div>
        </div>
      </div>
    `;

    const $ = {
      sTitle: shadow.getElementById('sTitle'),
      sTime:  shadow.getElementById('sTime'),
      summary: shadow.getElementById('summary'),
      recap:  shadow.getElementById('recap'),
      chips:  shadow.getElementById('chips'),
      note:   shadow.getElementById('note'),
      xp:     shadow.getElementById('xp'),
      prev:   shadow.getElementById('prev'),
      next:   shadow.getElementById('next'),
      pick:   shadow.getElementById('pick'),
      i:      shadow.getElementById('i'),
      t:      shadow.getElementById('t'),
      copied: shadow.getElementById('copied'),
      copy:   shadow.getElementById('copy'),
      picker: shadow.getElementById('picker'),
      pgrid:  shadow.getElementById('pgrid'),
      pclose: shadow.getElementById('pclose')
    };

    function key(page){ return `knotes:${state.userId}:${state.moduleId}:${page.id}`; }
    function keyNote(page){ return key(page)+':note'; }

    function render(idx){
      if (!state.pages.length) return;
      state.i = Math.max(0, Math.min(state.pages.length-1, idx ?? state.i));
      const p = state.pages[state.i];

      $.i.textContent = String(state.i+1);
      $.t.textContent = String(state.pages.length);
      $.prev.disabled = state.i===0;
      $.next.disabled = state.i===state.pages.length-1;

      $.sTitle.textContent = p.scene?.title || '';
      $.sTime.textContent  = p.scene?.time  || '';

      $.summary.innerHTML = (p.summary||[]).map(line=>`<div>${escapeHtml(line)}</div>`).join('');
      $.recap.innerHTML = (p.recap||[]).map(r=>`<div style="display:flex; justify-content:space-between; align-items:center; border:1px solid #eee; border-radius:10px; padding:8px 10px">
        <div style="font-weight:700">${escapeHtml(r.label||'Q')}</div>
        <div style="color:#6b7280">${escapeHtml(r.state||'review')}</div>
      </div>`).join('');
      $.chips.innerHTML = (p.concepts||[]).map(c=>`<div class="chip">${escapeHtml(c.name)}</div>`).join('');
      $.note.value = localStorage.getItem(keyNote(p)) || '';
      $.xp.textContent = `+${p.xp||0} XP`;

      // picker grid
      $.pgrid.innerHTML = state.pages.map((pg, i)=>`<button class="btn" data-i="${i}" style="text-align:left">
        Page ${i+1}<br><span style="color:#6b7280; font-weight:600">${escapeHtml(pg.scene?.title||'')}</span></button>`).join('');
      $.pgrid.querySelectorAll('button').forEach(b=> b.onclick=()=>{ $.picker.style.display='none'; api.goTo(+b.dataset.i); });
    }

    const saveDebounced = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), 500);} })((p,val)=>{
      localStorage.setItem(keyNote(p), val||'');
      state.saveReflection({ userId:state.userId, moduleId:state.moduleId, pageId:p.id, text:val||'' }).catch(()=>{});
      state.onEvent('reflection_saved', {pageId:p.id});
    });

    $.note.addEventListener('input', ()=> {
      const p = state.pages[state.i]; if (!p) return;
      saveDebounced(p, $.note.value);
    });

    $.prev.onclick = ()=> api.goTo(state.i-1);
    $.next.onclick = ()=> api.goTo(state.i+1);
    $.pick.onclick = ()=> { $.picker.style.display='grid'; };
    $.pclose.onclick = ()=> { $.picker.style.display='none'; };

    $.copy.onclick = async ()=>{
      const text = Array.from($.summary.querySelectorAll('div')).map(d=>d.textContent.trim()).join('\n');
      try{ await navigator.clipboard.writeText(text); $.copied.style.display='inline'; setTimeout(()=> $.copied.style.display='none', 900);}catch(e){}
    };

    const api = {
      updatePages(pages){
        state.pages = Array.isArray(pages) ? pages : [];
        state.i = 0; render(0);
      },
      goTo(i){ render(i); },
      getIndex(){ return state.i; }
    };

    render(0);
    container.appendChild(host);
    return api;
  }

  global.KnotesLite = { mount };
})(window);
</script>